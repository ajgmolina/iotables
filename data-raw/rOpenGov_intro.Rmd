---
title: "rOpenGov Intro"
author: "Daniel Antal, CFA"
date: "2021-05-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(iotables)
library(eurostat)
library(dplyr)
```


We have released a new version of [iotables](https://iotables.dataobservatory.eu/) as part of the [rOpenGov](http://ropengov.org/) project. The package, as the name suggests, works with European symmetric input-output tables (SIOTs). SIOTs are among the most complex governmental statistical products and they are estimated from various components of the GDP, tax collection, and other sources to understand how the economy’s 64 sectors are interrelated to each other.

SIOTs offer great value to policy-makers and analysts to make more than educated guesses on how a million euros, pounds or Czech korunas spent on a certain sector will impact other sectors of the economy, employment or GDP. What happens when a bank starts to give new loans and advertise them? How is an increase in economic activity going to affect the amount of wages paid and and where will consumers most likely spend their wages?
 
A topical area of interest, as the national economies begin to reopen after COVID-19 pandemic lockdowns, is to utilize SIOTs to calculate direct and indirect employment effects or value added effects of government grant programs to sectors such as cultural and creative industries or actors such as venues for performing arts, movie theaters, bars and restaurants.

Making such calculations requires a bit of matrix algebra, and understanding of input-output economics, direct, indirect effects, and multipliers. Economists, grant designers, policy makers have those skills, but until now, such calculations were either made in cumbersome Excel sheets, or proprietary software, as the key to these calculations is to keep vectors and matrices, which have at least one dimension of 64, perfectly aligned.

## Accessing and tidying the data programmatically

The iotables package is in a way an extension to the [rOpenGov package eurostat]( https://CRAN.R-project.org/package=eurostat), which provides a programmatic access to the [Eurostat](https://ec.europa.eu/eurostat) data warehouse. The reason for releasing a new package is that while working with simple datasets, or even more complex data ‘folders’ in the data warehouse is a trivial task, working with SIOTs requires plenty of meticulous data wrangling. 

When working with matrix equations, the requirements are more strict than “just working” with tidy data. Not only your rows and columns must match, but their ordering must strictly conform the quadrants of the a matrix system, including the connecting trade or tax matrices.

When you download a country’s SIOT table, you receive a long form data.frame, a very-very long one, which contains the matrix values and their labels like this:

```{r get-data, eval=FALSE}
naio_10_cp1700 <- eurostat::get_eurostat("naio_10_cp1700")

# we save it for further reference here 
saveRDS(naio_10_cp1700, "not_included/naio_10_cp1700_date_code_FF.rds")

# should you need to retrieve the large tempfiles, they are in 
dir (file.path(tempdir(), "eurostat"))
```
```{r show-head, eval=FALSE}
dplyr::slice_head(cp1700, n = 5)
```

The metadata reads like this: the units are in millions of euros, we are analyzing domestic flows, and the national account items `B1-B2` for the industry `A01`. Our package not only labels this data meaningfully, but creates very tidy data frames. 

Because the tidy data frames will be used in matrix algebraic equations, they do not only have to be tidy, but the information of a 64x64 matrix (the SIOT) and its connecting matrices, such as taxes, or employment, or $CO_{2}$ emissions, must be placed exactly in one correct ordering of columns and rows. Every single data wrangling error will usually lead in an error (the matrix equation has no solution), or, what is worse, in a very difficult to trace algebraic error. 

iotables package contains the vocabularies (abbreviations and human readable labels) of three statistical vocabularies: the so called COICOP product codes, the NACE industry codes, and the vocabulary of national accounts (which is the government equivalent of corporate accounting).

Most of the package functions are therefore metadata functions that filter out the relevant information from the warehouse and put them into matrices, where the column names refer to the SIOT or connecting matrix/vector columns, and the first (key) column provides the labeling information for the rows. Then, when the data is in the right format, we have simple functions that are removing the key column from the data frames, and solve the necessary matrix equations. 

Our package currently solves all equations for direct, indirect effects, multipliers and inter-industry linkages. Backward linkages show what happens with the suppliers of an industry, such as catering or advertising in the case of music festivals, if the festivals reopen. The forward linkages show how much extra demand this creates for connecting services that treat festivals as a ‘supplier’, such as cultural tourism.

## Let's seen an example

```{r employment-get, message=FALSE}
emp_sk <- employment_get(geo = "SK", year = "2019", sex = "Total",
                         age = "Y_GE15", labelling = "prod_na",
                         data_directory = NULL,
                         force_download = TRUE)

```

and match it with the latest structural information on from the [Symmetric input-output table at basic prices (product by product)](http://appsso.eurostat.ec.europa.eu/nui/show.do?wai=true&dataset=naio_10_cp1700) Eurostat product. A quick look at the Eurostat website already shows that there is a lot of work ahead to make the data look like an actual Symmetric input-output table. Download it with `iotable_get()` which does basic labelling and preprocessing on the raw Eurostat files. Because of the size of the unfiltered dataset on Eurostat, the following code may take several minutes to run.

```{r get-Slovak-table}
sk_io <-  iotable_get ( labelled_io_data = NULL, 
                        source = "naio_10_cp1700", geo = "SK", 
                        year = 2015, unit = "MIO_EUR", 
                        stk_flow = "TOTAL",
                        labelling = "iotables" )
```
The `input_coefficient_matrix_create()` creates the input coefficient matrix, which is used for most of the analytical functions. It performs the following equation, as it is numbered in the Eurostat Manual.

(9)  $a_{ij}$ = $X_{ij}$ / $x_j$  [recap: (43) is the same]

It checks the correct ordering of columns, and furthermore it fills up 0 values with 0.000001 to avoid division with zero. 

```{r}
input_coeff_matrix_sk <- input_coefficient_matrix_create(
  data_table = sk_io
)
```
```{r}
I_sk <- leontieff_inverse_create( input_coeff_matrix_sk )
```
```{r}
primary_inputs_sk <- coefficient_matrix_create(
  data_table = sk_io, 
  total = 'output', 
  return = 'primary_inputs')
```
```{r}
multipliers_sk <- input_multipliers_create( primary_inputs_sk, I_sk ) 
```



## Examples 

The [Germany 1990](https://iotables.dataobservatory.eu/articles/germany_1990.html) provides an introduction of input-output economics and re-creates the examples of the [Eurostat Manual of Supply, Use and Input-Output Tables](https://iotables.dataobservatory.eu/articles/germany_1990.html), by Jörg Beutel (Eurostat Manual).

The [United Kingdom Input-Output Analytical Tables Daniel Antal, based on the work edited by Richard Wild](https://iotables.dataobservatory.eu/articles/united_kingdom_2010.html) is a use case on how to correctly import data from outside Eurostat (i.e. not with `eurostat::get_eurostat()`) and join it properly to a SIOT.  We also used this example to create unit tests of our functions from a published, official government statistical release. 

Finally, [Working With Eurostat Data](https://iotables.dataobservatory.eu/articles/working_with_eurostat.html) is a detailed use case of working with all the current functionalities of the package by comparing two economies, Czechia and Slovakia. 

## Further plans

Our package allows the calculation of various economic policy scenarios, such as changing the VAT on meat or effects of re-opening music festivals on aggregate demand, GDP, tax revenues, or employment. 

But what about the CO2, methane and other greenhouse gas effects of the reopening festivals, or the increasing meat prices?

Technically our package can already calculate such effects, but to do so, you have to carefully match further statistical vocabulary items used by the European Environmental Agency about air pollutants and greenhouse gases.

In the next major release of the package we are planning to build in the necessary vocabulary into the metadata functions to increase the functionality of the package, and create new indicators for our [Green Deal Data Observatory](https://greendeal.dataobservatory.eu/). This experimental data observatory is creating new, high quality statistical indicators from open governmental and open science data sources that has not seen the daylight yet.  We hope to win the [EU Datathon Challenge 3: A European Green Deal](https://greendeal.dataobservatory.eu/) with creating an open-source data-as-service application with API to such difficult to use, high-value open data.  We would be very happy to see our users as contributors to this endeavor.
